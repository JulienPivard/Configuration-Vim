#! /bin/bash
# vim:foldmethod=marker:foldlevel=0
# Changer les droits avec chmod u+x fichier

# Dernière modification : Mercredi 16 mai[05] 2018

# Arrête le script si une variable non initialisé est utilisée
set -u
# Équivalent à set -o errtrace pour s'assurer que les trap sont bien
# hérité dans les sous shell
set -E
# Permet de traiter les erreurs dans les pipeline avec la trap ERR
set -o pipefail
set -o posix
# Activation du mode verbose affiche la commande qui va être exécuté
#set -v
# Activation du mode xtrace affiche le résultat de chaque commande
#set -x

###############################################################################
#                   ___                             __                        #
#                  /   |  _________ ___  ____  ____/ /__  ___                 #
#                 / /| | / ___/ __ `__ \/ __ \/ __  / _ \/ _ \                #
#                / ___ |(__  ) / / / / / /_/ / /_/ /  __/  __/                #
#               /_/  |_/____/_/ /_/ /_/\____/\__,_/\___/\___/                 #
#                                                                             #
###############################################################################

#(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)#
#                           configurationSourceVim                            #
#                          écrit par : PIVARD Julien                          #
#                       contact : pivardjulien@gmail.com                      #
#                                Novembre 2013                                #
#                                                                             #
#              Configuration et compilation des sources de vim.               #
#(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)(=^.^=)#

#############################################
# {{{ Fonctions de gestions généraliste     #
#############################################

declare -i NB_COULEURS=0

# which_cmd                     {{{
function which_cmd ()
{
    which "${1}" 2>/dev/null || command -v "${1}" 2>/dev/null
}

    #}}}

# test_cmd_exist                {{{
function test_cmd_exist ()
{
    which_cmd "${1}" >/dev/null 2>&1 && return 0
    return 1
}

    #}}}

#}}}

####################################
# {{{  Définition des couleurs     #
####################################

NEUTRE="" M_GRAS="" D_SOUL="" F_SOUL="" INVERS="" M__DIM=""

# Vérification de l'existence de la commande tput           #{{{
if test_cmd_exist tput
then
    [[ `tput colors 2>/dev/null` -ge 8 ]] &&
        declare -r NB_COULEURS=`tput colors` || declare -r NB_COULEURS=0

    declare -r NEUTRE="`tput sgr 0`" M_GRAS="`tput bold`" D_SOUL="`tput smul`"
    declare -r F_SOUL="`tput rmul`"  INVERS="`tput rev`"  M__DIM="`tput dim`"
else
    declare -r NB_COULEURS=0
fi

    #}}}

# Définition des couleurs                   #{{{
if [[ "${NB_COULEURS}" -gt 0 ]]
then
    declare -r C___NOIR="`tput setaf 0`" C__ROUGE="`tput setaf 1`"
    declare -r C___VERT="`tput setaf 2`" C__JAUNE="`tput setaf 3`"
    declare -r C___BLEU="`tput setaf 4`" C_VIOLET="`tput setaf 5`"
    declare -r C___CYAN="`tput setaf 6`" C__BLANC="`tput setaf 7`"

    declare -r C___INOIR="`tput setaf 8`"  C__IROUGE="`tput setaf 9`"
    declare -r C___IVERT="`tput setaf 10`" C__IJAUNE="`tput setaf 11`"
    declare -r C___IBLEU="`tput setaf 12`" C_IVIOLET="`tput setaf 13`"
    declare -r C___ICYAN="`tput setaf 14`" C__IBLANC="`tput setaf 15`"

    declare -r C_SUR___NOIR="`tput setab 0`" C_SUR__ROUGE="`tput setab 1`"
    declare -r C_SUR___VERT="`tput setab 2`" C_SUR__JAUNE="`tput setab 3`"
    declare -r C_SUR___BLEU="`tput setab 4`" C_SUR_VIOLET="`tput setab 5`"
    declare -r C_SUR___CYAN="`tput setab 6`" C_SUR__BLANC="`tput setab 7`"

    declare -r C_SUR___INOIR="`tput setab 8`" C_SUR__IROUGE="`tput setab 9`"
    declare -r C_SUR___IVERT="`tput setab 10`" C_SUR__IJAUNE="`tput setab 11`"
    declare -r C_SUR___IBLEU="`tput setab 12`" C_SUR_IVIOLET="`tput setab 13`"
    declare -r C_SUR___ICYAN="`tput setab 14`" C_SUR__IBLANC="`tput setab 15`"
else
    # Les couleurs sont mises à vide si tput n'est pas installé
    declare -r C___NOIR="" C__ROUGE="" C___VERT="" C__JAUNE=""
    declare -r C___BLEU="" C_VIOLET="" C___CYAN="" C__BLANC=""

    declare -r C___INOIR="" C__IROUGE="" C___IVERT="" C__IJAUNE=""
    declare -r C___IBLEU="" C_IVIOLET="" C___ICYAN="" C__IBLANC=""

    declare -r C_SUR___NOIR="" C_SUR__ROUGE="" C_SUR___VERT="" C_SUR__JAUNE=""
    declare -r C_SUR___BLEU="" C_SUR_VIOLET="" C_SUR___CYAN="" C_SUR__BLANC=""

    declare -r C_SUR___INOIR="" C_SUR__IROUGE="" C_SUR___IVERT="" C_SUR__IJAUNE=""
    declare -r C_SUR___IBLEU="" C_SUR_IVIOLET="" C_SUR___ICYAN="" C_SUR__IBLANC=""
fi

    #}}}

#}}}

####################################################
# {{{ Fonctions généraliste utilisant des couleurs #
####################################################

# ligne_vide                    {{{
function ligne_vide ()
{
    printf >&2 '\n'
}

    #}}}

# separateur_section            {{{
function separateur_section ()
{
    echo >&2 "--- ${NEUTRE}${M__DIM}${M_GRAS}${*}${NEUTRE} ---"
}

    #}}}

# message_ok                    {{{
function message_ok ()
{
    printf >&2 "${NEUTRE}${C_SUR___VERT}${C__BLANC}${M_GRAS} OK ${NEUTRE} "
    [[ "${#}" -gt 0 ]] && echo >&2 "${*}" || ligne_vide
    ligne_vide
}

    #}}}

# message_erreur                {{{
function message_erreur ()
{
    printf >&2 "${NEUTRE}${C_SUR__ROUGE}${C__BLANC}${M_GRAS} ERREUR ${NEUTRE} "
    [[ "${#}" -gt 0 ]] && echo >&2 "${*}" || ligne_vide
    ligne_vide
}

    #}}}

# message_attention             {{{
function message_attention ()
{
    printf >&2 "${NEUTRE}${C_SUR__JAUNE}${C__BLANC}${M_GRAS} Attention ! ${NEUTRE} "
    [[ "${#}" -gt 0 ]] && echo >&2 "${*}" || ligne_vide
    ligne_vide
}

    #}}}

# message_avertissement         {{{
function message_avertissement ()
{
    printf >&2 "${NEUTRE}${C_SUR___CYAN}${C__BLANC}${M_GRAS} Avertissement ! ${NEUTRE} "
    [[ "${#}" -gt 0 ]] && echo >&2 "${*}" || ligne_vide
    ligne_vide
}

    #}}}

# demander_utilisateur          {{{
function demander_utilisateur ()
{
    printf >&2 "${*} (o/n)\n"
    while read -r -n 1 -s reponse
    do
        [[ "${reponse}" = [OoYy] ]] && return 0
        [[ "${reponse}" = [Nn] ]] && return 1
    done
}

    #}}}

# affichage_echappee            {{{
declare METHODE_D_AFFICHAGE_ECHAPPEE
printf "%q " test >/dev/null 2>&1
[[ "${?}" -eq 0 ]] && METHODE_D_AFFICHAGE_ECHAPPEE="printfq"
function affichage_echappee ()
{
    if [[ "${METHODE_D_AFFICHAGE_ECHAPPEE}" == "printfq" ]]
    then
        printf "%q " "${@}"
    else
        printf "%s" "${*}"
    fi
    return 0
}

    #}}}

# executer_commande         {{{
FICHIER_LOG_EXECUTION="/dev/null"
function executer_commande ()
{
    local -r user="${USER--}" dir="${PWD}"
    local info info_console

    if [[ "${UID}" -eq 0 ]]
    then
        info="[root ${dir}]# "
        info_console="[${M__DIM}${dir}${NEUTRE}]# "
    else
        info="[${user} ${dir}]$ "
        info_console="[${M__DIM}${dir}${NEUTRE}]$ "
    fi

    # Consigne l'exécution de la commande dans les logs.
    printf >> "${FICHIER_LOG_EXECUTION}" "${info}"
    affichage_echappee >> "${FICHIER_LOG_EXECUTION}" "${@}"
    printf >> "${FICHIER_LOG_EXECUTION}" " ... "

    # Affiche l'exécution de la commande sur la sortie d'erreur standard.
    printf >&2 "${info_console}${M_GRAS}${C__JAUNE}"
    affichage_echappee >&2 "${@}"
    printf >&2 "${NEUTRE}\n"

    # Exécute la commande
    if "${@}"
    then
        local -r Code_Erreur=0
    else
        local -r Code_Erreur="${?}"
    fi

    if [[ "${Code_Erreur}" -ne 0 ]]
    then
        message_erreur
        printf >> "${FICHIER_LOG_EXECUTION}" "Erreur avec le code d'erreur : ${Code_Erreur}\n"
    else
        message_ok
        printf >> "${FICHIER_LOG_EXECUTION}" "OK\n"
    fi

    return "${Code_Erreur}"
}

    #}}}

# Fonction affiche_section       #{{{
affiche_section()
{
    declare -r COUL="${1}"
    declare -r t="${2}"
    declare -i largeur=80
    declare -i taille_txt="${#t}"
    largeur=$(( ( largeur - taille_txt ) / 2 ))
    printf >&2 "${COUL}"
    eval "printf >&2 '%.s ' {1..$largeur}"
    printf >&2 "${t}"
    eval "printf >&2 '%.s ' {1..$largeur}"
    printf >&2 "${NEUTRE}\n"
}

    #}}}

#}}}

# Si le PATH ne s'initialise pas correctement :
#export PATH='/usr/local/sbin:/usr/sbin:/sbin:/usr/local/bin:/usr/bin:/bin'

ligne_vide

#echo "Pour installer avec le support de clipboard installer xorg-dev"

if [[ -e "./src/vim" ]]
then
    affiche_section "${C_SUR__JAUNE}${C___NOIR}" 'Nettoyage de la compilation précédente'
    executer_commande make distclean
fi

affiche_section "${C_SUR___VERT}${C___NOIR}" 'Configuration de vim'

executer_commande ./configure --with-features=huge \
            --with-compiledby=Asmodee \
            --enable-multibyte \
            --enable-rubyinterp \
            --enable-perlinterp \
            --enable-pythoninterp=yes \
            --enable-cscope --disable-netbeans \
            --enable-gui=auto --with-x --prefix=/usr \
            --enable-fail-if-missing
erreur=$?

if [[ "${erreur}" -eq 0 ]]
then
    affiche_section "${C_SUR___VERT}${C___NOIR}" 'Compilation de vim'
    executer_commande make

    erreur=$?
    if [[ "${erreur}" -eq 0 ]]
    then
        affiche_section "${C_SUR___VERT}${C___NOIR}" 'Installation de vim'
        executer_commande sudo make install
    fi

else

    affiche_section "${C_SUR__JAUNE}${C___NOIR}" 'Erreur pendant la configuration'

    message_avertissement 'Certaines librairie pourraient ne pas être installée :'
    printf >&2 'sudo apt-get install libperl-dev python-dev ruby-dev libncurses5-dev'
    ligne_vide

fi

ligne_vide
